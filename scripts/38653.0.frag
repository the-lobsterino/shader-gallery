// TDF 7 by mtm(mitsuman)
// Tokyo Demo Fest 2017 GLSL Compo 2nd place
	
#ifdef GL_ES
precision mediump float;
#endif
uniform float time;uniform vec2 mouse;uniform vec2 resolution;float a(vec3 b,float c){return length(b)-c;}float d(vec3 b,vec3 e){vec3 f=abs(b)-e;return min(max(max(f.x,f.y),f.z),.0)+length(max(f,.0));}float g(float h,float i){return min(h,i);}float j(float h,float i){return max(-h,i);}float k(float h,float i){return max(h,i);}vec4 l;float m(vec3 b){b.x-=0.4*l.x;b.y-=0.2*l.x;float n=l.z;float o=d(b-vec3(.2,.7,0),vec3(.3,.1,n));float p=d(b-vec3(.2,.3,0),vec3(.1,.3,n));float q=g(o,p);float r=d(b-vec3(.8,.4,0),vec3(.1,.4,n));float s=d(b-vec3(1.0,.7,0),vec3(.1,.1,n));float t=d(b-vec3(1.0,.1,0),vec3(.1,.1,n));float u=d(b-vec3(1.2,.4,0),vec3(.1,.2,n));float v=g(g(g(r,s),t),u);float w=d(b-vec3(1.6,.4,0),vec3(.1,.4,n));float x=d(b-vec3(1.8,.7,0),vec3(.2,.1,n));float y=d(b-vec3(1.8,.3,0),vec3(.1,.1,n));float z=g(g(w,x),y);return g(g(q,v),z);}vec4 A,B,C;vec4 D(vec4 E){for(float F=0.;F<15.0;F+=1.0){vec4 b=E;E.xy=abs(b.xy);E.zw=b.wz;if(mod(F,2.0)<1.0){E.yw=E.wy;}float G=-2.*min(0.,dot(E,B));E+=G*B*l.w;G=-2.*min(0.,dot(E,C
));E+=G*C*l.w;}return E;}vec3 H(vec3 I){for(int F=1;F<5;F++){I.yzx+=sin((I.zxy+vec3(.0,2.01,4.1))*(float(F)*0.31))*3.14;}return I;}vec3 J(vec3 I,float K){vec4 L=vec4(H(I),(I.x+I.y+I.z)*0.4*K);for(int F=1;F<3;F++){I+=(H(L.xyz)+H(L.yzw)+H(L.zwx)+H(L.wxy)+I.zxy)*(float(F)*0.002);}return normalize(I)*I.x*I.x*I.y;}vec3 M(vec4 E,float N,float O){vec4 B=normalize(vec4(A.y,-1.,A.z,-0.3));vec4 C=normalize(vec4(sin(A.x-l.x*0.4),cos(A.x-l.x*0.1),-0.5,A.w));vec3 P;float K=1.0;for(float F=0.;F<15.0;F+=1.0){vec4 b=E;E.xy=abs(b.xy);E.zw=b.wz;P+=(sin(E.xyz*F))*K;K*=O;float G=-2.*min(0.,dot(E,B));E+=G*B;G=-2.*min(0.,dot(E,C));E+=G*C;}P=J(P,N);return P;}float Q(vec3 b){float f=m(D(vec4(b,.9)).xyz);f=k(a(b,3.+l.w*1e9),f);return f;}vec3 R(vec3 b){float f=0.01;return normalize(vec3(Q(b+vec3(f,0,0))-Q(b+vec3(-f,0,0)),Q(b+vec3(0,f,0))-Q(b+vec3(0,-f,0)),Q(b+vec3(0,0,f))-Q(b+vec3(0,0,-f))));}const int S=80;vec3 T(vec3 U,vec3 V,out int W,out float X){float G=0.;vec3 P,b;W=S;X=1e9;float Y=1.;for(int F=0;F<S;F++){b=U+G*V;float f=Q(b);if
(F==0&&f<=0.001) Y=-1.;if(Y<0.&&f<0.) f=0.5;G+=f;X=min(f,X);if(f<0.001){W=F;break;}if(G>1e3){W=-1;break;}}return b;}const float Z=8.0;vec3 ba(vec3 bb,vec3 V,vec3 bc,int W,float X){if(W<0){float A=max(0.,1.-X);return vec3(.4)*A;}float bd=max(dot(bc,-V),.0);float be=pow(max(dot(V,reflect(bc,-V)),.0),Z);vec3 bf=M(vec4(bb,.9),bd,be);vec3 bg=M(vec4(bb,.1),be,bd);return bf*be+bg*bd+vec3(.1);}float q=mod(time*1.,75.0);float bh=1.0;vec4 bi(float G,float bj,vec4 K){float bk=clamp(bj-abs(q-G),0.,1.);bk=min(bh,bk);bh-=bk;return K*bk;}void main(void){vec2 bl=(2.0*gl_FragCoord.xy-resolution)/resolution.x;l+=bi(0.,10.,vec4(.0,.0,1.0,1.0));l+=bi(8.,8.,vec4(.0,1.0,1.0,1.0));l+=bi(15.,10.,vec4(.0,.0,1.0,1.0));l+=bi(28.,8.,vec4(.0,.0,1.0,1.0));l+=bi(36.,12.,vec4(.0,15.0,2.0,1.0));l+=bi(50.,5.,vec4(.0,10.0,1.0,1.0));l+=bi(55.,4.99,vec4(1.0,7.0,.9,.5));l+=bi(60.,15.,vec4(1.8,2.8,.9,.0));if(q>54.) q=54.+(14.55)*(1.-exp((54.-q)*1.));bh=1.0;A+=bi(.0,3.0,vec4(-0.5,.1,-1.4,.9));A+=bi(3.0,3.0,vec4(-0.5,.1,-1.2,.5));A+=bi(5.0,5.0,vec4(
-0.6,.2,-0.8,.5));A+=bi(10.0,7.0,vec4(-0.5,.1,-0.7,.55));A+=bi(17.0,4.0,vec4(-0.3,.16,-0.4,.4));A+=bi(21.,3.,vec4(-0.2,.2,-0.2,.9));A+=bi(24.,3.,vec4(-0.15,.25,-0.15,.8));A+=bi(27.,3.,vec4(.1,.5,.2,0.));A+=bi(30.,3.,vec4(0.,.5,.0,-0.3));A+=bi(33.,3.,vec4(-0.2,.7,-0.5,-0.1));A+=bi(36.,3.,vec4(-0.3,.9,.1,0.));A+=bi(39.,2.,vec4(-0.0,.5,.1,.5));A+=bi(41.,2.,vec4(-0.0,.5,1.1,1.5));A+=bi(43.,2.,vec4(.5,.1,2.,3.));A+=bi(45.,2.,vec4(.2,.2,1.2,1.2));A+=bi(47.,2.,vec4(.2,.1,.8,.5));A+=bi(49.,5.,vec4(.0,2.,.6,5.5));A+=bi(60.,15.,vec4(.1,.3,.0,.5));float G=q;B=normalize(vec4(A.y,-1.,A.z,-0.3));C=normalize(vec4(sin(A.x),cos(A.x),-0.5,A.w));vec3 bm=vec3(3.*cos(G/2.0),-5.*sin(G/2.0),-0.8+l.y*(1.0+sin(G/1.8)));vec3 bn=normalize(-bm);vec3 bo=normalize(vec3(cos(G)*l.x*2.2,sin(G)*l.x*5.0,1.));vec3 bp=cross(bn,bo);vec3 V=normalize(bl.x*bp+bl.y*bo+bn);int W;float X;vec3 E=T(bm,V,W,X);vec3 P=ba(E,V,R(E),W,X);gl_FragColor=vec4(P,1.0);}