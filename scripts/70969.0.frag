/*
 * Original shader from: https://www.shadertoy.com/view/tlcBRn
 */

#ifdef GL_ES
precision mediump float;
#endif

// glslsandbox uniforms
uniform float time;
uniform vec2 resolution;

// shadertoy emulation
#define iTime time
#define iResolution resolution
const vec4 iMouse = vec4(0.);

// --------[ Original ShaderToy begins here ]---------- //
//CC0 1.0 Universal https://creativecommons.org/publicdomain/zero/1.0/
//To the extent possible under law, Blackle Mori has waived all copyright and related or neighboring rights to this work.

//like the last few shaders I've published, this is a neural network experiment.
//this time, the neural network reproduces an SDF given the x,y,z coordinates
//using siren networks with skip connections: https://vsitzmann.github.io/siren/

vec3 erot(vec3 p, vec3 ax, float ro) {
    return mix(dot(p,ax)*ax,p,cos(ro))+sin(ro)*cross(ax,p);
}

float scene(vec3 p) {
    //sdf is undefined outside the unit sphere, uncomment to witness the abominations
    if (length(p) > 1.) {
        return length(p)-.8;
    }
    //neural networks can be really compact... when they want to be
    //loss 0.000029
vec4 f0_0=sin(p.y*vec4(1.2632,-.4474,-1.6416,-1.9700)+p.z*vec4(-3.7059,2.3727,-3.0346,-1.6699)+p.x*vec4(-3.6727,1.5686,2.6528,-1.8901)+vec4(4.4913,5.6483,1.2559,-3.3162));
vec4 f0_1=sin(p.y*vec4(2.5220,-1.5557,3.8122,4.1715)+p.z*vec4(-1.2165,-1.3173,-.1438,-2.4906)+p.x*vec4(-1.1836,-2.5435,.9713,-2.0005)+vec4(7.7881,1.6291,-8.4022,-4.6355));
vec4 f0_2=sin(p.y*vec4(-1.2092,-2.4212,1.6790,-.3334)+p.z*vec4(-2.7181,-1.8660,-1.8368,-1.3239)+p.x*vec4(3.9888,1.2432,-.7674,-.7171)+vec4(-.5121,4.8613,-9.2752,6.8961));
vec4 f0_3=sin(p.y*vec4(-.5121,-3.4609,-4.3007,2.3322)+p.z*vec4(3.2620,-.9095,3.8431,.3971)+p.x*vec4(1.9224,4.3937,4.1179,-1.1763)+vec4(-6.0857,2.6647,3.8790,-2.7984));
vec4 f0_4=sin(p.y*vec4(-3.2372,2.1402,4.1189,-.0498)+p.z*vec4(-3.9081,-2.4637,-4.0778,-1.5805)+p.x*vec4(2.6973,.8373,.4440,-3.8287)+vec4(5.5065,-2.5670,.3069,5.9119));
vec4 f1_0=sin(mat4(-.2030,-.0166,.0861,.1473,.0157,-.4203,-.1172,.5038,.1738,.6207,.3993,.0234,.2756,-.4501,-.3217,-.1521)*f0_0+
    mat4(.3372,.0944,.2702,-.4503,-.7030,.3255,-.4739,-.7047,.2768,-.0771,.4603,-.1116,-.2451,.3518,-.2185,-.2396)*f0_1+
    mat4(.2793,.0815,-.3349,.1531,.3772,-.4190,-.0756,.1997,-.3136,-.2914,.4888,-.0856,.1340,.5022,-.1579,-.0839)*f0_2+
    mat4(-.5827,.4362,.1809,-.0966,.2169,-.2873,.0176,.2701,.1930,-.2114,-.0373,.0470,.1253,-.7260,.1469,-.0836)*f0_3+
    mat4(.4069,-.0364,-.2703,-.2900,.4172,.3168,.6248,-.0403,.0053,.0766,.3893,.0449,-.0293,.6825,.0756,-.1236)*f0_4+
    vec4(-1.6198,-3.3837,.6589,.9996))/1.0+f0_0;
vec4 f1_1=sin(mat4(.0855,.2338,.5000,.5493,.1280,.3476,.4233,-.2769,-.1698,.1865,.5364,.4069,.2147,-.0679,.2228,-.2257)*f0_0+
    mat4(-.1097,-.2199,-.3771,.1350,-.2112,-.0963,.0856,-.1926,-.2100,-.3727,.0848,-.2653,-.3822,.0155,.1768,-.0770)*f0_1+
    mat4(.3850,-.1738,-.3386,.3555,.1722,-.1544,-.1904,-.0276,-.2311,.2091,.0290,.2139,.7012,-.0027,-.2310,.3771)*f0_2+
    mat4(.0461,.5519,-.3326,-.5854,-.0540,.2727,.0335,-.0678,-.4049,-.2475,.1827,.2271,.3179,.1274,.2774,-.1993)*f0_3+
    mat4(-.2692,.0134,.0559,-.0542,.8574,.4699,.2710,-.3354,.1969,.1184,-.0551,-.1399,.2529,-.1221,.1963,.4669)*f0_4+
    vec4(2.8984,-1.5152,1.6113,1.2535))/1.0+f0_1;
vec4 f1_2=sin(mat4(-.3563,-.0636,-.4670,-.6493,-.7619,.2155,.1386,.5344,.2283,.1117,.0734,-.5088,1.3651,-1.1937,.1367,-.5142)*f0_0+
    mat4(.0506,-.3768,.1755,.3447,.1936,.0338,.0467,-.0262,.3925,.3007,-.0661,.2351,-.1642,.3968,.6239,-.3125)*f0_1+
    mat4(.2443,-.2109,-.2980,-.1739,-.2382,.1990,-.1598,.3970,.5521,-.9104,.1562,-.0781,-.5015,.0187,-.0441,-.3009)*f0_2+
    mat4(.3728,.2042,-.3391,.0873,.0832,-.0895,.0987,.0456,-.2270,.1410,-.1347,-.3103,-1.1568,.0752,-.3703,.3464)*f0_3+
    mat4(-.1900,-.0996,.1235,-.1077,.1842,-.2153,-.2797,.6692,-.3546,-.0257,.0088,.2227,-.3828,-.3478,.2423,.4912)*f0_4+
    vec4(.0772,1.2415,-.9642,.4207))/1.0+f0_2;
vec4 f1_3=sin(mat4(-.4543,-.2159,.0975,.2680,.1087,-.4273,.4554,.1685,-.5196,-.2140,-.1711,-.4337,-.5900,-.1515,.1607,.2343)*f0_0+
    mat4(.6079,.1127,.3612,.2098,.0469,.1671,.7072,-.3346,.5109,-.4723,.0335,.0138,-.1616,.3248,-.6344,-.0244)*f0_1+
    mat4(.2215,.1082,-.1012,-.4156,.3172,-.4527,-.0469,.4991,.2614,-.6256,.5853,-.4187,.1115,-.2908,-.2356,-.2383)*f0_2+
    mat4(-.4884,-.0441,-.0977,-.2307,.2439,-.6773,-.1803,.0193,-.1736,-.3430,.3694,.1951,.5472,.3916,.0286,-.5495)*f0_3+
    mat4(.0089,-.1734,.5013,.0379,-.4755,-.6163,.2412,.3247,.0788,-.2992,.3127,.4021,-.4547,-.1574,-.3216,-.4623)*f0_4+
    vec4(2.6759,.9408,2.5947,-2.5565))/1.0+f0_3;
vec4 f1_4=sin(mat4(.4366,-.1865,.5375,-.0139,.1592,.2961,-.2362,-.2684,.2532,.0294,-.1603,.3578,.5209,.2173,.5656,-.0542)*f0_0+
    mat4(.0602,-.2551,.3082,.0680,.1624,.0986,-.0102,-.3071,-.5301,-.1378,.0413,.2370,-.3719,.1627,.0903,-.3725)*f0_1+
    mat4(.0692,-.1001,.0345,.2077,.3484,.5508,.1359,.2217,.0328,.3554,.9924,.0345,-.4453,-.1294,-.3994,-.4885)*f0_2+
    mat4(.3812,.2838,-.0478,.0424,-.6274,-.4210,.3162,-.0911,-.0971,-.2368,-.3586,-.4033,-.2743,.0673,-.2240,.0213)*f0_3+
    mat4(-.3487,-.0492,-.2157,-.1900,-.2847,-.3772,.3989,.2874,-.1189,.2767,.0883,.1036,.3270,-.0994,.5501,.3114)*f0_4+
    vec4(-.2600,.9513,2.6996,-1.9643))/1.0+f0_4;
vec4 f2_0=sin(mat4(-.1333,-.0108,.2697,-.0964,.1478,-.1686,-.3708,.0842,-.3042,-.3603,-.0706,.0706,-.2647,-.5484,.3849,-.2464)*f1_0+
    mat4(-.2547,.0165,.4382,-.3602,.2055,.1740,.4286,.2042,.5634,.0507,-.3306,.3638,.0197,-.3600,-.4072,.2665)*f1_1+
    mat4(-.4024,-.3089,-.1075,.1778,-.2549,-.2042,.1577,-.1551,-.2803,.0602,.3457,.0714,-.1006,-.4176,-.3729,.1240)*f1_2+
    mat4(-.6384,.5551,.0009,-.0988,-.5924,-.0013,-.1091,-.2420,.1662,-.0932,-.4496,.1024,.2107,.2109,.4477,.5569)*f1_3+
    mat4(.0135,.0471,.0331,.1163,-.4092,-.3248,.3039,-.3749,-.1562,.0362,.3252,-.0318,.4027,.1621,.4053,-.3421)*f1_4+
    vec4(-1.0686,-2.3183,2.6724,2.0133))/1.4+f1_0;
vec4 f2_1=sin(mat4(.0689,.3505,.1136,-.1087,.1963,-.0394,-.0976,-.6363,-.1541,-.3352,.4934,-.0032,-.5988,.1947,-.1374,.1375)*f1_0+
    mat4(-.4649,-.2995,-.2994,.1164,-.4094,-.0887,-.2360,.6393,-.2505,.0587,-.3562,-.2754,.3594,.2655,-.3463,.2802)*f1_1+
    mat4(.0112,-.3255,.4323,.1533,-.2879,-.6944,-.0591,.2440,.0526,-.3313,.0294,.0783,.0993,.4864,-.1626,-.4043)*f1_2+
    mat4(.3061,.2691,.4492,.1796,-.0934,-.4549,.0312,-.0989,-.1946,.2317,.3669,-.1565,-.3521,.3912,-.1920,-.2984)*f1_3+
    mat4(.0839,.6889,.6988,.7423,-.4353,.4475,.3665,.1242,.5676,.6399,-.4509,.0784,.8658,.0140,-.0599,-.0634)*f1_4+
    vec4(-2.8648,-1.2714,.3665,-1.7416))/1.4+f1_1;
vec4 f2_2=sin(mat4(-.4528,-.0595,.1017,-.3053,.3789,-.0701,-.3347,.3034,.8299,.7693,.1254,-.4438,-.4916,.7326,.0489,.1299)*f1_0+
    mat4(-.1633,.1187,-.0911,-.1949,.1390,.0092,.5803,-.2348,.4056,-.3376,-.3508,.0148,.0118,.2554,.1916,-.3500)*f1_1+
    mat4(-.1349,.0609,-.2520,.1171,.6290,.0200,-.5962,.3303,.0280,-.1414,.4372,.0359,-.3312,-.2851,-.3995,-.3204)*f1_2+
    mat4(-.3762,.5278,.0026,.2238,.2754,.0029,.1344,-.1775,.2565,.2512,.2449,.1902,-.3966,-.2008,-.3970,-.4463)*f1_3+
    mat4(.4212,.0792,-.3017,.1657,-.2680,-.2345,.1628,.1072,-.4852,.0275,-.3765,-.1802,-.2632,-.2907,.1021,.2776)*f1_4+
    vec4(-2.4228,.7212,-.3526,1.3372))/1.4+f1_2;
vec4 f2_3=sin(mat4(-.4040,.3040,.4556,-.6665,-.0632,-.0489,.3784,-.8446,-.3771,.3597,.3137,.1647,.3290,-.7886,-.1977,.7321)*f1_0+
    mat4(-.0710,-.0779,-.4948,.5407,-.0485,-.1638,.5147,.4961,.0019,-.2047,-.4281,.2300,-.5643,.5197,-.0997,.6508)*f1_1+
    mat4(.7479,-.1056,.1704,.1076,-.1914,.3516,-.6295,-.4986,.4167,-.0115,.3496,-.2936,-.3450,-.3999,.4396,-.4599)*f1_2+
    mat4(-.1500,-.0935,-.3247,-.2135,.0435,.2112,-.4532,.4235,-.1455,.5177,.1256,.1542,-.3781,.3252,-.9591,.5634)*f1_3+
    mat4(.2959,.2948,-.0872,-.0211,.5531,.1916,-.4974,-.0425,-.1634,-.3007,-.3458,.0161,-.3802,.1224,1.1963,-.0788)*f1_4+
    vec4(2.0275,-.8806,-2.9277,2.5813))/1.4+f1_3;
vec4 f2_4=sin(mat4(.2341,.4573,.3950,-.3017,-.4927,-.3446,.2778,-.4941,.1453,.7412,-.0084,.3976,-.0546,.0818,-.3502,-.0657)*f1_0+
    mat4(.0610,-.4560,-.2228,.0943,.5567,.6241,-.8234,.5571,-.0320,-.1656,.3895,.0105,.1292,.5179,.0182,-.6004)*f1_1+
    mat4(-.0906,-.8685,.2922,-.3989,-.5139,-.8915,-.0999,-.2520,.2494,-.6709,-.5403,-.2153,.0275,.4071,.8565,.3386)*f1_2+
    mat4(-.1375,.0326,.2100,-.2246,-.1606,.4789,-.1572,.1390,.2415,.1762,-.0586,.2296,.1112,.2190,.4537,-.9142)*f1_3+
    mat4(-.0454,.1146,.2091,-.0852,.0149,.2272,.4778,.2541,-.2463,.3613,-.0192,-.0826,-.0214,.1311,-.1306,.0554)*f1_4+
    vec4(2.7219,.7040,-2.8782,-1.5355))/1.4+f1_4;
vec4 f3_0=sin(mat4(-.2881,.0741,-.4255,-.0803,.1456,-.4055,-.2692,.1384,.0387,-.0381,.2491,-.5632,.7052,-.0724,.1795,-.4274)*f2_0+
    mat4(.2543,-.1512,.8961,.0912,.8350,.0423,.5628,.2610,.0648,.1623,.0858,.2532,-.4720,.5712,.4415,-.3604)*f2_1+
    mat4(-.1994,-.3609,.3288,.1350,-.3315,.3190,-.2830,.3628,.0455,.0948,.0125,.4429,.0180,-.6527,.5138,-.1803)*f2_2+
    mat4(.0153,-.5056,.3476,.0526,-.8151,-.2322,-.1678,.1371,.0247,.2850,-.0765,-.2918,-.2710,-.1467,.0737,-.0027)*f2_3+
    mat4(.0651,-.0400,.1499,-.3054,-.0094,-.1873,.7323,-.4813,-.1385,.0179,-.2424,-.5961,.5071,.3268,-.1069,.3192)*f2_4+
    vec4(-.7740,2.2524,.4700,-2.6111))/1.7+f2_0;
vec4 f3_1=sin(mat4(.4738,-.4807,.2942,.2792,.6008,-.1364,.0064,.2382,.2731,.2627,.3926,.0604,-.2351,.2796,-.6701,-.0806)*f2_0+
    mat4(-.4117,-.2036,.0309,-.1217,.1516,-.1413,.6943,.3150,.1780,-.6771,.4726,.0516,.0467,-.3451,.1158,-.1679)*f2_1+
    mat4(.0195,.2276,-.2403,-.1412,.4855,.3706,-.4724,-.8361,.1805,.6278,.3265,-.1882,.2571,.2416,-.3043,1.3898)*f2_2+
    mat4(-.1805,-.4123,.3200,-.5357,-.6237,.4865,.3008,.4388,.7147,.3452,.5053,.2270,-.2231,-.2682,-.7869,-.1636)*f2_3+
    mat4(-.2231,-.0037,.2238,.4704,-.3847,-.5527,.1725,-.1131,.4923,.2430,-.6472,-.4090,-.0169,-.1082,-.2886,.2729)*f2_4+
    vec4(-1.9194,-1.1206,-1.2247,1.0181))/1.7+f2_1;
vec4 f3_2=sin(mat4(.6211,-.5363,.3312,-.0550,.2558,.5621,.3169,.2315,.3504,.7586,.3150,-.6395,-.1785,.2569,-.8484,-.4343)*f2_0+
    mat4(-.4613,-.3345,-.4018,.0267,-.0444,-.2442,.3266,.5478,.0108,.5639,.0687,.0248,-.0384,.1148,-.2127,-.1664)*f2_1+
    mat4(-.0921,-.1652,-.5729,-.5389,.4428,-.4280,.5613,.1055,.3616,.2393,.1721,-.0669,.3315,.1442,-.3011,.1665)*f2_2+
    mat4(-.1126,.1036,-.5391,-.4459,.4004,.4003,-.1019,-.2513,-.1877,.2670,.6086,.3509,-.1585,-.6668,-.5634,.0269)*f2_3+
    mat4(.4369,.2598,-.1968,.3429,-.9361,.2553,.0637,.2361,-.0245,-.2238,-.2055,-.2881,.0978,-.8699,-.6149,-.6125)*f2_4+
    vec4(-1.1165,1.6697,1.5972,-.7447))/1.7+f2_2;
vec4 f3_3=sin(mat4(.5301,.0033,.9131,.2662,.0914,-.2720,.5263,-.0144,.4701,-.2504,.1533,.4081,.5531,.4887,-.6222,.4363)*f2_0+
    mat4(-.4762,.1507,-.1294,-.8157,-.3780,.4539,-.2638,-.3620,-.0017,-.5752,-.0825,-.0114,-.1856,.2761,.2695,.0570)*f2_1+
    mat4(-.2307,.3019,.1454,-.0206,-.6685,-.0220,-1.0370,.3813,.2000,-.0500,-.1370,-.4813,.2867,.1561,.2848,-.2261)*f2_2+
    mat4(-.4074,.6135,-.1537,-.2047,.2833,-.2795,.6339,-.4983,.5112,.1506,-.1177,.6921,-.2647,-.4477,.3702,.1323)*f2_3+
    mat4(.1857,.1503,.3762,.0568,-.0865,-.0239,-.0206,-.3809,.0331,.2804,-.4189,-.1006,-.4610,-.3417,.0268,.1064)*f2_4+
    vec4(-1.8433,-1.6963,-2.9217,1.9606))/1.7+f2_3;
vec4 f3_4=sin(mat4(.1033,-.3116,.1328,.6146,-.1269,-.8655,-.0599,.1469,-.8008,.4528,.3230,.0837,.2273,.0335,-.0708,.8812)*f2_0+
    mat4(.4610,-.2398,.5365,.2568,-.2568,-.1726,.0841,-.9253,.2995,-.5034,-.5854,-.8084,.4572,-.2002,.3184,-.4990)*f2_1+
    mat4(.4558,-.1122,.0666,-.4014,-.2773,.6112,.2984,.3000,.3743,-.4890,.5105,-.0436,.7102,-.0990,-.2355,.0778)*f2_2+
    mat4(.4361,-.2809,-.0774,-.2724,-.3153,.0834,-.1359,.1195,.1479,-.4664,-.2218,.2175,.2787,-.3279,-.3552,-.4022)*f2_3+
    mat4(.0258,.9482,-.2850,-.0464,-.2873,-.4864,.4599,.1463,-.3419,-.3891,-.2531,.2308,.4401,-1.1061,-.2136,-.2552)*f2_4+
    vec4(-.8992,.0549,-.4045,2.6533))/1.7+f2_4;
return dot(f3_0,vec4(-.0469,.0326,.0446,.0586))+
    dot(f3_1,vec4(-.0355,-.0228,.0340,.0395))+
    dot(f3_2,vec4(-.0312,-.0144,-.0636,.0644))+
    dot(f3_3,vec4(-.0284,-.0316,.0296,-.0307))+
    dot(f3_4,vec4(.0495,.0172,-.0344,-.0213))+
    0.0187;
}

vec3 norm(vec3 p) {
    mat3 k = mat3(p,p,p)-mat3(0.001);
    return normalize(scene(p) - vec3(scene(k[0]),scene(k[1]),scene(k[2])));
}

void mainImage( out vec4 fragColor, in vec2 fragCoord )
{
    vec2 uv = (fragCoord-0.5*iResolution.xy)/iResolution.y;
    vec2 mouse = (iMouse.xy-0.5*iResolution.xy)/iResolution.y;

    vec3 cam = normalize(vec3(1.5,uv));
    vec3 init = vec3(-2.,0,0);
    
    float yrot = 0.;
    float zrot = 3. + iTime*.2;
    if (iMouse.z > 0.) {
        yrot += -4.*mouse.y;
        zrot = 4.*mouse.x;
    }
    cam = erot(cam, vec3(0,1,0), yrot);
    init = erot(init, vec3(0,1,0), yrot);
    cam = erot(cam, vec3(0,0,1), zrot);
    init = erot(init, vec3(0,0,1), zrot);
    
    vec3 p = init;
    bool hit = false;
    for (int i = 0; i < 150; i++) {
        if (hit) break;
        float dist = scene(p);
        hit = dist*dist < 1e-6;
        p+=dist*cam;
        if (distance(p,init)>5.) break;
    }
    vec3 n = norm(p);
    vec3 r = reflect(cam,n);
    //don't ask how I stumbled on this texture
    vec3 nz = p - erot(p, vec3(1), 2.) + erot(p, vec3(1), 4.);
    float spec = length(sin(r*3.5+sin(nz*120.)*.15)*.4+.6)/sqrt(3.);
    spec *= smoothstep(-.3,.2,scene(p+r*.2));
    vec3 col = vec3(.1,.1,.12)*spec + pow(spec,8.);
    float bgdot = length(sin(cam*8.)*.4+.6)/2.;
    vec3 bg = vec3(.1,.1,.11) * bgdot + pow(bgdot, 10.);
    fragColor.xyz = hit ? col : bg;
    fragColor = smoothstep(-.02,1.05,sqrt(fragColor)) * (1.- dot(uv,uv)*.5);
}
// --------[ Original ShaderToy ends here ]---------- //

void main(void)
{
    mainImage(gl_FragColor, gl_FragCoord.xy);
}